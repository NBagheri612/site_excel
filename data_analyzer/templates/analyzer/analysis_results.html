{% extends 'base.html' %}

{% block title %}نتایج تحلیل هوشمند - {{ file_name }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-12">
        <!-- Success Header -->
        <div class="glass-card p-4 mb-4 animate__animated animate__fadeIn">
            <div class="text-center">
                <div class="feature-icon mx-auto mb-3 bg-success">
                    <i class="bi bi-robot text-white display-6"></i>
                </div>
                <h2 class="fw-bold text-success mb-2">تحلیل هوشمند انجام شد!</h2>
                <p class="text-muted">سیستم هوش مصنوعی داده‌های شما را تحلیل کرد</p>
                
                {% if basic_info.has_date_columns %}
                <div class="alert alert-info mt-3">
                    <i class="bi bi-calendar-check me-2"></i>
                    <strong>تحلیل زمانی فعال شد!</strong> 
                    ستون‌های تاریخ شناسایی شده: {{ basic_info.date_columns|join:", " }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="stat-card p-3 text-center">
                    <i class="bi bi-list-ol display-6 mb-2"></i>
                    <h4 class="fw-bold">{{ basic_info.rows }}</h4>
                    <small>تعداد ردیف</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card p-3 text-center">
                    <i class="bi bi-columns display-6 mb-2"></i>
                    <h4 class="fw-bold">{{ basic_info.columns }}</h4>
                    <small>تعداد ستون</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card p-3 text-center">
                    <i class="bi bi-exclamation-triangle display-6 mb-2"></i>
                    <h4 class="fw-bold">{{ basic_info.missing_total }}</h4>
                    <small>داده مفقودی</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card p-3 text-center">
                    <i class="bi bi-graph-up display-6 mb-2"></i>
                    <h4 class="fw-bold">{{ all_analyses|length }}</h4>
                    <small>دسته‌بندی تحلیل</small>
                </div>
            </div>
        </div>

        <!-- Analysis Tabs -->
        <div class="glass-card p-4">
            <!-- Tab Navigation -->
            <ul class="nav nav-pills mb-4" id="analysisTabs" role="tablist">
                {% for category, analyses in all_analyses.items %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if forloop.first %}active{% endif %}" 
                            id="{{ category }}-tab" 
                            data-bs-toggle="pill" 
                            data-bs-target="#{{ category }}" 
                            type="button" 
                            role="tab">
                        <i class="bi 
                            {% if category == 'پایه' %}bi-bar-chart
                            {% elif category == 'زمانی' %}bi-clock
                            {% elif category == 'آماری' %}bi-calculator
                            {% elif category == 'کسب‌وکار' %}bi-graph-up-arrow
                            {% else %}bi-file-earmark-text{% endif %} me-2">
                        </i>
                        {{ category }}
                        <span class="badge bg-secondary ms-2">{{ analyses|length }}</span>
                    </button>
                </li>
                {% endfor %}
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="analysisTabsContent">
                {% for category, analyses in all_analyses.items %}
                <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                     id="{{ category }}" 
                     role="tabpanel">
                    
                    <!-- Category Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold text-{{ 
                            'primary' if category == 'پایه' 
                            else 'warning' if category == 'زمانی' 
                            else 'info' if category == 'آماری' 
                            else 'success' 
                        }}">
                            <i class="bi 
                                {% if category == 'پایه' %}bi-bar-chart
                                {% elif category == 'زمانی' %}bi-clock
                                {% elif category == 'آماری' %}bi-calculator
                                {% elif category == 'کسب‌وکار' %}bi-graph-up-arrow
                                {% else %}bi-file-earmark-text{% endif %} me-2">
                            </i>
                            تحلیل‌های {{ category }}
                        </h5>
                        
                        <a href="{% url 'download_analysis_report' category file_name %}" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-download me-1"></i>
                            دانلود گزارش {{ category }}
                        </a>
                    </div>

                    <!-- Analysis Cards -->
                    <div class="row g-4">
                        {% for analysis_name, analysis_data in analyses.items %}
                        <div class="col-lg-12 mb-4">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi 
                                            {% if 'مفقود' in analysis_name %}bi-exclamation-triangle text-warning
                                            {% elif 'همبستگی' in analysis_name %}bi-arrow-left-right text-info
                                            {% elif 'نرمال' in analysis_name %}bi-check-circle text-success
                                            {% elif 'پرت' in analysis_name %}bi-exclamation-octagon text-danger
                                            {% else %}bi-graph-up text-primary{% endif %} me-2">
                                        </i>
                                        {{ analysis_name }}
                                    </h6>
                                    <span class="badge bg-primary">
                                        {{ analysis_data.data.shape.0 }} × {{ analysis_data.data.shape.1 }}
                                    </span>
                                </div>
                                
                                <div class="card-body">
                                    <!-- Insights Section -->
                                    {% if analysis_data.insights %}
                                    <div class="alert alert-info mb-3">
                                        <h6 class="alert-heading">
                                            <i class="bi bi-lightbulb me-2"></i>
                                            بینش‌های هوشمند
                                        </h6>
                                        <ul class="mb-0">
                                            {% for insight in analysis_data.insights %}
                                            <li>{{ insight }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}

                                    <!-- Recommendations Section -->
                                    {% if analysis_data.recommendations %}
                                    <div class="alert alert-warning mb-3">
                                        <h6 class="alert-heading">
                                            <i class="bi bi-rocket-takeoff me-2"></i>
                                            راهکارهای عملی
                                        </h6>
                                        <ul class="mb-0">
                                            {% for recommendation in analysis_data.recommendations %}
                                            <li>{{ recommendation|safe }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}

                                    <!-- Data Table -->
                                    <div class="table-responsive" style="max-height: 400px;">
                                        <table class="table table-sm table-hover">
                                            <thead class="table-light sticky-top">
                                                <tr>
                                                    <th>شاخص</th>
                                                    {% for col in analysis_data.data.columns %}
                                                    <th>{{ col }}</th>
                                                    {% endfor %}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for index, row in analysis_data.data.iterrows %}
                                                <tr>
                                                    <th scope="row" class="text-nowrap">{{ index }}</th>
                                                    {% for value in row %}
                                                    <td>
                                                        {% if value is True or value == 'بله' %}
                                                            <span class="badge bg-success">بله</span>
                                                        {% elif value is False or value == 'خیر' %}
                                                            <span class="badge bg-danger">خیر</span>
                                                        {% elif value == 'خطا' %}
                                                            <span class="badge bg-warning">خطا</span>
                                                        {% else %}
                                                            {{ value }}
                                                        {% endif %}
                                                    </td>
                                                    {% endfor %}
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    {% if analyses.items|length == 0 %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted mb-3"></i>
                        <p class="text-muted">تحلیلی در این دسته‌بندی موجود نیست</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Summary Section -->
        <div class="glass-card p-4 mt-4">
            <h5 class="fw-bold mb-3">
                <i class="bi bi-star me-2 text-warning"></i>
                خلاصه تحلیل هوشمند
            </h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="alert alert-success">
                        <h6><i class="bi bi-check-circle me-2"></i>نقاط قوت</h6>
                        <ul class="mb-0">
                            <li>تحلیل جامع و خودکار داده‌ها</li>
                            <li>شناسایی الگوها و روندهای پنهان</li>
                            <li>ارائه راهکارهای عملی و قابل اجرا</li>
                            <li>پشتیبانی از تحلیل‌های پیشرفته آماری</li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-info">
                        <h6><i class="bi bi-lightning me-2"></i>گام بعدی</h6>
                        <ul class="mb-0">
                            <li>اجرای راهکارهای پیشنهادی</li>
                            <li>مانیتورینگ مستمر شاخص‌ها</li>
                            <li>بهبود مستمر کیفیت داده‌ها</li>
                            <li>استفاده از تحلیل‌های پیشرفته‌تر</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mt-5">
            <div class="d-flex gap-3 justify-content-center flex-wrap">
                <a href="{% url 'upload_dataset' %}" class="btn btn-gradient btn-lg">
                    <i class="bi bi-cloud-upload me-2"></i>
                    تحلیل فایل جدید
                </a>
                <a href="{% url 'home' %}" class="btn btn-outline-primary btn-lg">
                    <i class="bi bi-house me-2"></i>
                    صفحه اصلی
                </a>
            </div>
            
            <!-- Download All -->
            <div class="mt-4">
                <a href="{% url 'download_analysis_report' 'all' file_name %}" class="btn btn-success">
                    <i class="bi bi-file-earmark-excel me-2"></i>
                    دانلود همه گزارش‌ها (Excel)
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const triggerTabList = [].slice.call(document.querySelectorAll('#analysisTabs button'))
        triggerTabList.forEach(function (triggerEl) {
            const tabTrigger = new bootstrap.Tab(triggerEl)
            triggerEl.addEventListener('click', function (event) {
                event.preventDefault()
                tabTrigger.show()
            })
        })
    });
</script>
{% endblock %}